# Prebuilt MS image
FROM mcr.microsoft.com/playwright:focal@sha256:2286c685f2be91dd3ee482f1a3d382af08c9a1049406c9f7b499aec6ad691a2c

ARG UID=1000
ARG GID=1000
ARG UNAME=node

RUN groupadd --gid $GID --non-unique node
RUN useradd --create-home --uid $UID --gid $GID --non-unique --shell /bin/bash node

RUN mkdir -p /app
RUN chown $UNAME:$UNAME /app

# Install PNPM globally
RUN npm i -g pnpm@10.28.2

USER $UNAME
WORKDIR /app

COPY --chown=$UNAME:$UNAME . .
COPY --chown=$UNAME:$UNAME .env.tests .env.production

RUN pnpm install --frozen-lockfile

USER root
RUN pnpm exec playwright install --with-deps chromium

USER $UNAME
RUN pnpm run build

# Expose port
EXPOSE 4040

CMD ["pnpm", "exec", "playwright", "test"]
